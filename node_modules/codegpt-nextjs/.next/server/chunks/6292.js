"use strict";exports.id=6292,exports.ids=[6292],exports.modules={16292:(e,t,n)=>{n.d(t,{t2:()=>x,qy:()=>S,Ks:()=>I,lu:()=>N,HP:()=>function e(t,n){let o;if(o=Symbol.asyncIterator in t?w(D(t)).pipeThrough(_((null==n?void 0:n.experimental_onFunctionCall)||(null==n?void 0:n.experimental_onToolCall)?{...n,onFinal:void 0}:{...n})):x(t,function(){let e=R();return t=>e(JSON.parse(t))}(),(null==n?void 0:n.experimental_onFunctionCall)||(null==n?void 0:n.experimental_onToolCall)?{...n,onFinal:void 0}:{...n}),!n||!n.experimental_onFunctionCall&&!n.experimental_onToolCall)return o.pipeThrough(T(null==n?void 0:n.experimental_streamData));{let t=function(t){let n=new TextEncoder,o=!0,a="",r="",l=!1,i=t[O]||[],c=null==t?void 0:t.experimental_streamData,s=function(e){let t=new TextDecoder;return function(e){return e?t.decode(e,{stream:!0}):""}}();return new TransformStream({async transform(e,t){let i=s(e);if(r+=i,o&&(i.startsWith('{"function_call":')||i.startsWith('{"tool_calls":'))){l=!0,a+=i,o=!1;return}if(l)a+=i;else{t.enqueue(c?n.encode(g("text",i)):e);return}},async flush(s){try{if(!o&&l&&(t.experimental_onFunctionCall||t.experimental_onToolCall)){let o;l=!1;let u=JSON.parse(a),d=[...i];if(t.experimental_onFunctionCall){void 0===u.function_call&&console.warn("experimental_onFunctionCall should not be defined when using tools");let e=JSON.parse(u.function_call.arguments);o=await t.experimental_onFunctionCall({name:u.function_call.name,arguments:e},e=>d=[...i,{role:"assistant",content:"",function_call:u.function_call},{role:"function",name:u.function_call.name,content:JSON.stringify(e)}])}if(t.experimental_onToolCall){let e={tools:[]};for(let t of u.tool_calls)e.tools.push({id:t.id,type:"function",func:{name:t.function.name,arguments:t.function.arguments}});let n=0;try{o=await t.experimental_onToolCall(e,e=>{if(e){let{tool_call_id:t,function_name:o,tool_call_result:a}=e;d=[...d,...0===n?[{role:"assistant",content:"",tool_calls:u.tool_calls.map(e=>({id:e.id,type:"function",function:{name:e.function.name,arguments:JSON.stringify(e.function.arguments)}}))}]:[],{role:"tool",tool_call_id:t,name:o,content:JSON.stringify(a)}],n++}return d})}catch(e){console.error("Error calling experimental_onToolCall:",e)}}if(o){if("string"==typeof o){s.enqueue(c?n.encode(g("text",o)):n.encode(o)),r=o;return}}else{s.enqueue(n.encode(c?g(u.function_call?"function_call":"tool_calls",JSON.parse(a)):a));return}let f={...t,onStart:void 0};t.onFinal=void 0;let p=e(o,{...f,[O]:d}).getReader();for(;;){let{done:e,value:t}=await p.read();if(e)break;s.enqueue(t)}}}finally{t.onFinal&&r&&await t.onFinal(r)}}})}(n);return o.pipeThrough(t)}},wn:()=>$});let o=[239,187,191];var a={code:"0",name:"text",parse:e=>{if("string"!=typeof e)throw Error('"text" parts expect a string value.');return{type:"text",value:e}}},r={code:"1",name:"function_call",parse:e=>{if(null==e||"object"!=typeof e||!("function_call"in e)||"object"!=typeof e.function_call||null==e.function_call||!("name"in e.function_call)||!("arguments"in e.function_call)||"string"!=typeof e.function_call.name||"string"!=typeof e.function_call.arguments)throw Error('"function_call" parts expect an object with a "function_call" property.');return{type:"function_call",value:e}}},l={code:"2",name:"data",parse:e=>{if(!Array.isArray(e))throw Error('"data" parts expect an array value.');return{type:"data",value:e}}},i={code:"3",name:"error",parse:e=>{if("string"!=typeof e)throw Error('"error" parts expect a string value.');return{type:"error",value:e}}},c={code:"4",name:"assistant_message",parse:e=>{if(null==e||"object"!=typeof e||!("id"in e)||!("role"in e)||!("content"in e)||"string"!=typeof e.id||"string"!=typeof e.role||"assistant"!==e.role||!Array.isArray(e.content)||!e.content.every(e=>null!=e&&"object"==typeof e&&"type"in e&&"text"===e.type&&"text"in e&&null!=e.text&&"object"==typeof e.text&&"value"in e.text&&"string"==typeof e.text.value))throw Error('"assistant_message" parts expect an object with an "id", "role", and "content" property.');return{type:"assistant_message",value:e}}},s={code:"5",name:"assistant_control_data",parse:e=>{if(null==e||"object"!=typeof e||!("threadId"in e)||!("messageId"in e)||"string"!=typeof e.threadId||"string"!=typeof e.messageId)throw Error('"assistant_control_data" parts expect an object with a "threadId" and "messageId" property.');return{type:"assistant_control_data",value:{threadId:e.threadId,messageId:e.messageId}}}},u={code:"6",name:"data_message",parse:e=>{if(null==e||"object"!=typeof e||!("role"in e)||!("data"in e)||"string"!=typeof e.role||"data"!==e.role)throw Error('"data_message" parts expect an object with a "role" and "data" property.');return{type:"data_message",value:e}}},d={code:"7",name:"tool_calls",parse:e=>{if(null==e||"object"!=typeof e||!("tool_calls"in e)||"object"!=typeof e.tool_calls||null==e.tool_calls||!Array.isArray(e.tool_calls)||e.tool_calls.some(e=>{null!=e&&"object"==typeof e&&"id"in e&&"string"==typeof e.id&&"type"in e&&"string"==typeof e.type&&"function"in e&&null!=e.function&&"object"==typeof e.function&&"arguments"in e.function&&"string"==typeof e.function.name&&e.function.arguments}))throw Error('"tool_calls" parts expect an object with a ToolCallPayload.');return{type:"tool_calls",value:e}}},f={code:"8",name:"message_annotations",parse:e=>{if(!Array.isArray(e))throw Error('"message_annotations" parts expect an array value.');return{type:"message_annotations",value:e}}},p=[a,r,l,i,c,s,u,d,f],m={[a.code]:a,[r.code]:r,[l.code]:l,[i.code]:i,[c.code]:c,[s.code]:s,[u.code]:u,[d.code]:d,[f.code]:f},y=(a.name,a.code,r.name,r.code,l.name,l.code,i.name,i.code,c.name,c.code,s.name,s.code,u.name,u.code,d.name,d.code,f.name,f.code,p.map(e=>e.code)),h=e=>{let t=e.indexOf(":");if(-1===t)throw Error("Failed to parse stream string. No separator found.");let n=e.slice(0,t);if(!y.includes(n))throw Error(`Failed to parse stream string. Invalid code ${n}.`);let o=JSON.parse(e.slice(t+1));return m[n].parse(o)};function g(e,t){let n=p.find(t=>t.name===e);if(!n)throw Error(`Invalid stream part type: ${e}`);return`${n.code}:${JSON.stringify(t)}
`}function _(e){let t=new TextEncoder,n="",o=e||{};return new TransformStream({async start(){o.onStart&&await o.onStart()},async transform(e,a){a.enqueue(t.encode(e)),n+=e,o.onToken&&await o.onToken(e)},async flush(){o.onCompletion&&await o.onCompletion(n),!o.onFinal||"experimental_onFunctionCall"in o||await o.onFinal(n)}})}function v(){let e=!0;return t=>(e&&(t=t.trimStart())&&(e=!1),t)}function x(e,t,n){if(!e.ok){if(!e.body)return new ReadableStream({start(e){e.error(Error("Response error: No response body"))}});{let t=e.body.getReader();return new ReadableStream({async start(e){let{done:n,value:o}=await t.read();if(!n){let t=new TextDecoder().decode(o);e.error(Error(`Response error: ${t}`))}}})}}return(e.body||new ReadableStream({start(e){e.close()}})).pipeThrough(function(e){let t;let n=new TextDecoder;return new TransformStream({async start(n){t=function(e){let t,n,a,r,l,i,c;return s(),{feed:function(s){var u;n=n?n+s:s,t&&(u=n,o.every((e,t)=>u.charCodeAt(t)===e))&&(n=n.slice(o.length)),t=!1;let d=n.length,f=0,p=!1;for(;f<d;){let t;p&&("\n"===n[f]&&++f,p=!1);let o=-1,s=r;for(let e=a;o<0&&e<d;++e)":"===(t=n[e])&&s<0?s=e-f:"\r"===t?(p=!0,o=e-f):"\n"===t&&(o=e-f);if(o<0){a=d-f,r=s;break}a=0,r=-1,function(t,n,o,a){if(0===a){c.length>0&&(e({type:"event",id:l,event:i||void 0,data:c.slice(0,-1)}),c="",l=void 0),i=void 0;return}let r=o<0,s=t.slice(n,n+(r?a:o)),u=0;u=r?a:" "===t[n+o+1]?o+2:o+1;let d=n+u,f=a-u,p=t.slice(d,d+f).toString();if("data"===s)c+=p?"".concat(p,"\n"):"\n";else if("event"===s)i=p;else if("id"!==s||p.includes("\0")){if("retry"===s){let t=parseInt(p,10);Number.isNaN(t)||e({type:"reconnect-interval",value:t})}}else l=p}(n,f,s,o),f+=o+1}f===d?n="":f>0&&(n=n.slice(f))},reset:s};function s(){t=!0,n="",a=0,r=-1,l=void 0,i=void 0,c=""}}(t=>{if("data"in t&&"event"===t.type&&"[DONE]"===t.data||"done"===t.event){n.terminate();return}if("data"in t){let o=e?e(t.data,{event:t.event}):t.data;o&&n.enqueue(o)}})},transform(e){t.feed(n.decode(e))}})}(t)).pipeThrough(_(n))}function w(e){let t=e[Symbol.asyncIterator]();return new ReadableStream({async pull(e){let{done:n,value:o}=await t.next();n?e.close():e.enqueue(o)},async cancel(e){var n;await (null==(n=t.return)?void 0:n.call(t,e))}})}function T(e){if(!e)return new TransformStream({transform:async(e,t)=>{t.enqueue(e)}});let t=new TextEncoder,n=new TextDecoder;return new TransformStream({transform:async(e,o)=>{let a=n.decode(e);o.enqueue(t.encode(g("text",a)))}})}async function*b(e){for await(let t of e)if("completion"in t){let e=t.completion;e&&(yield e)}else if("delta"in t){let{delta:e}=t;if("text"in e){let t=e.text;t&&(yield t)}}}function S(e,t){if(Symbol.asyncIterator in e)return w(b(e)).pipeThrough(_(t)).pipeThrough(T(null==t?void 0:t.experimental_streamData));{let n;return x(e,(n="",e=>{let t=JSON.parse(e);if("error"in t)throw Error(`${t.error.type}: ${t.error.message}`);if(!("completion"in t))return;let o=t.completion;if(!n||o.length>n.length&&o.startsWith(n)){let e=o.slice(n.length);return n=o,e}return o}),t).pipeThrough(T(null==t?void 0:t.experimental_streamData))}}((e,t=21)=>(n=t)=>{let o="",a=n;for(;a--;)o+=e[Math.random()*e.length|0];return o})("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",7);var C=new TextDecoder("utf-8");async function E(e,t){for(let n of e){let{text:e,is_finished:o}=JSON.parse(n);o||t.enqueue(e)}}async function j(e,t){let n="";for(;;){let{value:o,done:a}=await e.read();if(a)break;let r=(n+=C.decode(o,{stream:!0})).split(/\r\n|\n|\r/g);n=r.pop()||"",await E(r,t)}if(n){let e=[n];await E(e,t)}t.close()}async function*F(e){for await(let t of e)if("text-generation"===t.eventType){let e=t.text;e&&(yield e)}}function I(e,t){return Symbol.asyncIterator in e?w(F(e)).pipeThrough(_(t)).pipeThrough(T(null==t?void 0:t.experimental_streamData)):(function(e){var t;let n=null==(t=e.body)?void 0:t.getReader();return new ReadableStream({async start(e){if(!n){e.close();return}await j(n,e)}})})(e).pipeThrough(_(t)).pipeThrough(T(null==t?void 0:t.experimental_streamData))}function N(e,t){return(function(e){let t=v();return new ReadableStream({async pull(n){var o,a;let{value:r,done:l}=await e.next();if(l){n.close();return}let i=t(null!=(a=null==(o=r.token)?void 0:o.text)?a:"");if(i){if(null!=r.generated_text&&r.generated_text.length>0||"</s>"===i||"<|endoftext|>"===i||"<|end|>"===i)return;n.enqueue(i)}}})})(e).pipeThrough(_(t)).pipeThrough(T(null==t?void 0:t.experimental_streamData))}async function*D(e){let t=R();for await(let n of e){"promptFilterResults"in n&&(n={id:n.id,created:n.created.getDate(),object:n.object,model:n.model,choices:n.choices.map(e=>{var t,n,o,a,r,l,i;return{delta:{content:null==(t=e.delta)?void 0:t.content,function_call:null==(n=e.delta)?void 0:n.functionCall,role:null==(o=e.delta)?void 0:o.role,tool_calls:(null==(r=null==(a=e.delta)?void 0:a.toolCalls)?void 0:r.length)?null==(i=null==(l=e.delta)?void 0:l.toolCalls)?void 0:i.map((e,t)=>({index:t,id:e.id,function:e.function,type:e.type})):void 0},finish_reason:e.finishReason,index:e.index}})});let e=t(n);e&&(yield e)}}function R(){let e;let t=v();return o=>{var a,r,l,i,c,s,u,d,f,p,m,y,h,g,_,v,x,w;if(q(o)){let t=null==(a=o.choices[0])?void 0:a.delta;if(null==(r=t.function_call)?void 0:r.name)return e=!0,`{"function_call": {"name": "${t.function_call.name}", "arguments": "`;if(null==(c=null==(i=null==(l=t.tool_calls)?void 0:l[0])?void 0:i.function)?void 0:c.name){e=!0;let n=t.tool_calls[0];return 0===n.index?`{"tool_calls":[ {"id": "${n.id}", "type": "function", "function": {"name": "${null==(s=n.function)?void 0:s.name}", "arguments": "`:`"}}, {"id": "${n.id}", "type": "function", "function": {"name": "${null==(u=n.function)?void 0:u.name}", "arguments": "`}if(null==(d=t.function_call)?void 0:d.arguments)return n(null==(f=t.function_call)?void 0:f.arguments);if(null==(y=null==(m=null==(p=t.tool_calls)?void 0:p[0])?void 0:m.function)?void 0:y.arguments)return n(null==(_=null==(g=null==(h=t.tool_calls)?void 0:h[0])?void 0:g.function)?void 0:_.arguments);else if(e&&((null==(v=o.choices[0])?void 0:v.finish_reason)==="function_call"||(null==(x=o.choices[0])?void 0:x.finish_reason)==="stop"))return e=!1,'"}}';else if(e&&(null==(w=o.choices[0])?void 0:w.finish_reason)==="tool_calls")return e=!1,'"}}]}'}return t(q(o)&&o.choices[0].delta.content?o.choices[0].delta.content:"choices"in o&&o.choices&&o.choices[0]&&"text"in o.choices[0]?o.choices[0].text:"")};function n(e){let t=e.replace(/\\/g,"\\\\").replace(/\//g,"\\/").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\f/g,"\\f");return`${t}`}}var O=Symbol("internal_openai_fn_messages");function q(e){return"choices"in e&&e.choices&&e.choices[0]&&"delta"in e.choices[0]}var $=class extends Response{constructor(e,t,n){let o=e;n&&(o=e.pipeThrough(n.stream)),super(o,{...t,status:200,headers:{"Content-Type":"text/plain; charset=utf-8","X-Experimental-Stream-Data":n?"true":"false",...null==t?void 0:t.headers}})}}}};